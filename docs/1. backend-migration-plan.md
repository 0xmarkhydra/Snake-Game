# Kế Hoạch Port Server Cũ Sang Backend NestJS

Tài liệu này phác thảo cách chuyển toàn bộ logic Colyseus server cũ (thư mục `server/`) sang dự án NestJS mới (`backend/`). Nội dung chia thành các phần: hiện trạng, kiến trúc đích, mapping module, kế hoạch database, tích hợp Colyseus và các bước triển khai.

---

## 1. Hiện Trạng Server Cũ

- **Entrypoint**: `server/src/rooms/SnakeGameRoom.ts` điều khiển toàn bộ vòng đời trò chơi.
- **Trạng thái**: `SnakeGameState.ts` quản lý players, foods, game tick.
- **Kết nối**: Client sử dụng `colyseusClient.joinOrCreate('snake_game')` để vào phòng.
- **Giới hạn hiện tại**:
  - Không có xác thực, chỉ dựa vào sessionId.
  - Không lưu trữ dữ liệu người dùng hay credit.
  - Không có API REST, mọi thứ giao tiếp qua Colyseus messages.

---

## 2. Kiến Trúc Đích Trong `backend/`

- **Nest Modules chính**:
  - `AuthModule`: nonce, verify chữ ký Phantom, JWT.
  - `UserModule`: quản lý hồ sơ, nickname.
  - `WalletModule`: credit, deposit, withdraw.
  - `GameModule`: quản lý room, reward, giao tiếp Colyseus.
  - `WebhookModule`: tiếp nhận DepositEvent.
  - `TransactionModule`: log deposit/withdraw/reward.
- **Shared/Core**:
  - Interceptor chuẩn hóa response (`format-response.interceptor` đã có).
  - Guard JWT (`jwt-auth.guard`).
  - Swagger decorator (`ApiBaseResponse`) để áp chuẩn tài liệu.

---

## 3. Mapping Chức Năng

| Tính năng cũ (`server/`) | Module mới trong Nest | Ghi chú |
| --- | --- | --- |
| Khởi tạo phòng `snake_game` | `GameModule` + Colyseus Gateway | Tạo room free |
| Xử lý player join/leave | `GameService` + Colyseus adapter | Áp dụng JWT để xác thực |
| Vòng lặp game `gameLoop()` | Giữ nguyên trong Colyseus room nhưng di chuyển vào thư mục `backend/src/modules/game/rooms` | Tách `snake_game` và `snake_game_vip` |
| Spawn/kill food | Giữ trong room logic | Đồng bộ credit khi kill |
| Broadcast message | Sử dụng Colyseus broadcast | Không đổi |
| Boost/Move handling | Giữ trong room logic | Không đổi |
| Score logic | Bỏ (thay bằng credit) hoặc giữ song song | Cần mapping với wallet |

---

## 4. Database (PostgreSQL) Mapping

### Entities mới
- `UserEntity`: id, walletAddress (unique), displayName, createdAt, updatedAt.
- `UserSessionEntity`: id, userId, jwtId, expiresAt, createdAt.
- `WalletBalanceEntity`: id, userId, balance (decimal hoặc bigint), updatedAt.
- `TransactionEntity`: id, userId, type (deposit/withdraw/reward/system), amount, signature, metadata(JSONB), status, createdAt.
- `KillLogEntity`: id, killerId, victimId, roomType, amountEarned, createdAt.

### Migration Steps
1. Tạo migration bằng `pnpm nx g migration` (hoặc `typeorm` CLI) trong `backend`.
2. Seed dữ liệu cơ bản nếu cần (ex: admin config).
3. Chuẩn hóa repository/service trong `modules/database`.

---

## 5. Tích Hợp Colyseus Vào Nest

### Option A – Chạy Colyseus trong Nest
- Tạo `GameGateway` trong `backend/modules/game` để khởi tạo Colyseus `Server`.
- Đăng ký room classes (free & vip) từ `backend/modules/game/rooms`.
- Sử dụng DI của Nest để inject service vào room (ví dụ `WalletService` để cập nhật credit).
- Lợi ích: quản lý cấu hình tập trung, dễ dùng NestLogger, guard, service.

### Option B – Giữ server Colyseus riêng
- NestJS chỉ làm REST API, webhook, DB.
- Colyseus chạy độc lập (có thể refactor nhẹ để gọi API Nest).  
- Thích hợp nếu muốn tách microservice, nhưng cần bảo trì hai deploy.

> **Khuyến nghị**: Option A (merge vào Nest) để tận dụng cấu trúc hiện có, giảm độ phức tạp, dễ gọi service nội bộ.

---

## 6. API & Colyseus Interaction

### 6.1 Luồng Join Room VIP
1. Client gửi `POST /auth/nonce` → ký nonce → `POST /auth/verify` → nhận JWT.
2. Nếu user cần nạp → gọi `POST /wallet/deposit` để nhận hướng dẫn & SDK.
3. Poll `GET /wallet/credit`.
4. Khi đủ credit: `POST /game/vip-ticket` → trả về ticket/timestamp.
5. Client gọi Colyseus `joinOrCreate('snake_game_vip', { token, ticket })`.
6. Room kiểm tra ticket (gọi `GameService.validateTicket`) → cho phép join.

### 6.2 Reward 90/10
1. Room phát hiện kill → gọi `GameService.handleKill(killerId, victimId)`.
2. Service kiểm tra `wallet_balance` victim; nếu đủ credit:
   - Trừ 1 token nạn nhân.
   - Cộng 0.9 token cho killer.
   - Ghi `transaction` & `kill_log`.
3. Room broadcast credit mới cho client (thêm message `creditUpdate`).

### 6.3 Withdraw
1. Client `POST /wallet/withdraw`.
2. `WalletService` kiểm tra balance, tạo transaction pending.
3. Gọi HTTP tới dịch vụ bên ngoài (qua `HttpService` + retry).
4. Cập nhật transaction status + balance.
5. Gửi thông báo lại game client (nếu cần reload credit).

---

## 7. Kế Hoạch Triển Khai Chi Tiết

### Sprint 1
1. Thiết lập environment (`.env`, config DB, swagger).  
2. Tạo entity/migration DB.  
3. Hoàn thiện module Auth (nonce, verify, JWT guard).  
4. API Wallet (credit CRUD, get balance).  
5. Webhook deposit (endpoint + logging).

### Sprint 2
1. Tích hợp Colyseus vào Nest (Option A).  
2. Port `SnakeGameRoom` thành `FreeGameRoom`.  
3. Tạo `VipGameRoom` (kế thừa logic, thêm credit check).  
4. `GameService` xử lý reward 90/10.  
5. Viết test cơ bản cho game service & webhook.

### Sprint 3
1. API Withdraw + third-party integration.  
2. Bổ sung transactional logging & error handling.  
3. Swagger docs cho toàn bộ API.  
4. Cải thiện monitoring/logging (Nest logger + interceptors).

### Sprint 4 (Polish)
1. Tối ưu performance (batch updates, caching credit nếu cần).  
2. Security hardening (rate limit, cors, validation).  
3. Viết guide deploy (Dockerfile, PM2, v.v.).  
4. Dọn dẹp thư mục `server/` hoặc chuyển sang archive.

---

## 8. Checklist Song Song Cho Client

- Tích hợp Phantom login, lưu JWT.  
- Update Colyseus join logic (gửi token/ticket).  
- Bổ sung UI nạp token với lựa chọn số lượng.  
- Poll credit & hiển thị trong game.  
- Thêm nút Withdraw.  
- Điều chỉnh HUD hiển thị kill credit thay vì score.

---

## 9. Ghi Chú

- Đảm bảo mọi API trả về chuẩn `StandardResponseDto`.  
- Thêm unit test cho service quan trọng (auth, wallet, game).  
- Cân nhắc dùng queue (BullMQ) nếu webhook/withdraw cần retry.  
- Thiết lập `.env` chuẩn, tránh commit credential.

---

Tài liệu này là nền để bắt đầu di trú. Khi vào triển khai, có thể mở rộng từng mục (ví dụ chi tiết DTO, swagger, migration script).

